/*
 * pixelate.js
 * 43081j
 * Pixelate images with ease
 * License: MIT
 */
(function(window, $) {

	var pixelate = function(args) {
		

		var options = {
			value: args.value || 0.05,
			reveal: args.reveal || false,
			revealonclick:  args.revealonclick || false
		};
		
		

		
		var element = this, //arguments[0],
			elementParent = element.parentNode;
		
		
		var display = element.style.display,
			imgWidth = element.width,
			imgHeight = element.height,
			revealed = false;
		var canv = document.createElement('canvas');
		canv.width = imgWidth;
		canv.height = imgHeight;
		var ctx = canv.getContext('2d');
		ctx.mozImageSmoothingEnabled = false;
		ctx.webkitImageSmoothingEnabled = false;
		ctx.imageSmoothingEnabled = false;
		var width = imgWidth * options.value,
			height = imgHeight * options.value;
		ctx.drawImage(element, 0, 0, width, height);
		ctx.drawImage(canv, 0, 0, width, height, 0, 0, canv.width, canv.height);
		element.style.display = 'none';
		elementParent.insertBefore(canv, element);
		if(options.revealonclick !== false && options.revealonclick !== 'false') {
			/*
			 * Reveal on click
			 */
			canv.addEventListener('click', function(e) {
				revealed = !revealed;
				if(revealed) {
					ctx.drawImage(element, 0, 0, imgWidth, imgHeight);
				} else {
					ctx.drawImage(element, 0, 0, width, height);
					ctx.drawImage(canv, 0, 0, width, height, 0, 0, canv.width, canv.height);
				}
			});
		}
		if(options.reveal !== false && options.reveal !== 'false') {
			/*
			 * Reveal on hover
			 */
			canv.parentNode.parentNode.addEventListener('mouseenter', function(e) {
				if(revealed) return;
				ctx.drawImage(element, 0, 0, imgWidth, imgHeight);
			});
			canv.parentNode.parentNode.addEventListener('mouseleave', function(e) {
				if(revealed) return;
				ctx.drawImage(element, 0, 0, width, height);
				ctx.drawImage(canv, 0, 0, width, height, 0, 0, canv.width, canv.height);
			});
		}
	};


	window.HTMLImageElement.prototype.pixelate = pixelate;
	if(typeof $ === 'function') {
		$.fn.extend({
			pixelate: function(args) {
				return this.each(function() {
					
					pixelate.call(this, args);
				});
			}
		});
	}
	document.addEventListener('DOMContentLoaded', function(e) {
		var img = document.querySelectorAll('img[data-pixelate]');
		for(var i = 0; i < img.length; i++) {
			img[i].addEventListener('load', function(test) {
				this.pixelate();
			});
		};
	});
})(window, typeof jQuery === 'undefined' ? null : jQuery);